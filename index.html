<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pedidos - Super Negrelli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(20, 184, 166, 0.2);
            transition: all 0.3s ease;
        }
        .glass-effect:hover {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(20, 184, 166, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(20, 184, 166, 0.1);
        }
        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.6);
            transform: scale(1.02);
            transition: all 0.2s ease;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        .bounce-in {
            animation: bounceIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        .toast {
            transition: all 0.3s ease;
            transform: translateY(-10px);
        }
        .item-enter {
            animation: itemEnter 0.3s ease-out;
        }
        .item-exit {
            animation: itemExit 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3) translateY(20px); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes itemEnter {
            from { transform: translateY(-10px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        @keyframes itemExit {
            to { transform: translateX(100px) scale(0.8); opacity: 0; }
        }
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { 
                display: block !important; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 80mm;
                color: black !important;
                background: white !important;
            }
            @page {
                margin: 5mm;
                size: 80mm auto;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-950 via-black to-gray-900 min-h-screen text-white">
    <div class="container mx-auto p-4 sm:p-6 max-w-6xl">
        <!-- Header -->
        <div class="text-center mb-6 sm:mb-8 fade-in">
            <div class="flex items-center justify-center mb-4">
                <img src="SuperNegrelli.png" alt="Super Negrelli" class="h-16 sm:h-20 lg:h-24 w-auto">
            </div>
            <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold bg-gradient-to-r from-green-400 to-teal-500 bg-clip-text text-transparent mb-2">
                Sistema de Pedidos
            </h1>
            <p class="text-gray-300 text-sm sm:text-base">Gestão de Pedidos | Super Negrelli</p>
        </div>

        <!-- Main Form -->
        <div class="grid lg:grid-cols-2 gap-4 lg:gap-6">
            <!-- Dados do Cliente -->
            <div class="glass-effect rounded-xl p-4 sm:p-6 slide-in">
                <h2 class="text-xl font-semibold mb-4 text-green-400 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                    Dados do Cliente
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Telefone</label>
                        <input type="tel" id="telefone" placeholder="(11) 99999-9999" 
                               class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 input-glow">
                        <button id="buscarCliente" class="mt-2 px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm transition-all duration-200 hover:scale-105 flex items-center gap-2">
                            <svg class="w-4 h-4 loading-icon hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <svg class="w-4 h-4 search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            Buscar Cliente
                        </button>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Nome</label>
                        <input type="text" id="nome" placeholder="Nome completo do cliente"
                               class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 input-glow">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">CEP</label>
                        <input type="text" id="cep" placeholder="00000-000"
                               class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 input-glow">
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="sm:col-span-1">
                            <label class="block text-sm font-medium mb-2">Rua</label>
                            <input type="text" id="rua" placeholder="Nome da rua"
                                   class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 input-glow">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Número</label>
                            <input type="text" id="numero" placeholder="123"
                                   class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 input-glow">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Complemento</label>
                        <input type="text" id="complemento" placeholder="Apto, bloco, etc."
                               class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 input-glow">
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Bairro</label>
                            <input type="text" id="bairro" placeholder="Nome do bairro"
                                   class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 input-glow">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Cidade</label>
                            <input type="text" id="cidade" placeholder="Nome da cidade"
                                   class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 input-glow">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Itens -->
            <div class="glass-effect rounded-xl p-4 sm:p-6 slide-in">
                <h2 class="text-xl font-semibold mb-4 text-teal-400 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5L2 21m5-8v8a2 2 0 002 2h6a2 2 0 002-2v-8"/>
                    </svg>
                    Itens do Pedido
                </h2>
                
                <div class="space-y-3">
                    <!-- Mobile: Layout em coluna -->
                    <div class="block sm:hidden space-y-3">
                        <input type="number" id="quantidade" placeholder="Quantidade" min="0.1" step="0.1"
                               class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500">
                        <select id="unidade" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="un">Unidade</option>
                            <option value="kg">Quilograma</option>
                            <option value="g">Gramas</option>
                            <option value="cx">Caixa</option>
                            <option value="pct">Pacote</option>
                            <option value="L">Litros</option>
                            <option value="ml">Mililitros</option>
                        </select>
                        <input type="text" id="descricao" placeholder="Descrição do produto"
                               class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500">
                    </div>
                    
                    <!-- Desktop: Layout em linha -->
                    <div class="hidden sm:grid grid-cols-12 gap-2">
                        <input type="number" id="quantidade-desktop" placeholder="Qtd" min="0.1" step="0.1"
                               class="col-span-3 p-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 text-sm">
                        <select id="unidade-desktop" class="col-span-2 p-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 text-sm">
                            <option value="un">un</option>
                            <option value="kg">kg</option>
                            <option value="g">g</option>
                            <option value="cx">cx</option>
                            <option value="pct">pct</option>
                            <option value="L">L</option>
                            <option value="ml">ml</option>
                        </select>
                        <input type="text" id="descricao-desktop" placeholder="Descrição do produto"
                               class="col-span-7 p-2 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <button id="adicionarItem" class="w-full py-2 bg-teal-600 hover:bg-teal-700 rounded-lg transition-all duration-200 hover:scale-105 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Adicionar Item
                    </button>
                </div>

                <div class="mt-6">
                    <h3 class="font-medium mb-3">Lista de Compras:</h3>
                    <div id="listaItens" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Itens serão adicionados aqui -->
                    </div>
                    <!-- Removido campo de total pois valores foram removidos -->
                </div>
            </div>
        </div>

        <!-- Forma de Pagamento -->
        <div class="glass-effect rounded-xl p-4 sm:p-6 mt-4 sm:mt-6 fade-in">
            <h2 class="text-xl font-semibold mb-4 text-green-400 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                </svg>
                Forma de Pagamento
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                <button class="pagamento-btn p-3 bg-gray-900 hover:bg-gray-800 border border-gray-700 rounded-lg transition-all" data-tipo="debito">
                    Cartão Débito
                </button>
                <button class="pagamento-btn p-3 bg-gray-900 hover:bg-gray-800 border border-gray-700 rounded-lg transition-all" data-tipo="credito">
                    Cartão Crédito
                </button>
                <button class="pagamento-btn p-3 bg-gray-900 hover:bg-gray-800 border border-gray-700 rounded-lg transition-all" data-tipo="vale">
                    Vale Alimentação
                </button>
                <button class="pagamento-btn p-3 bg-gray-900 hover:bg-gray-800 border border-gray-700 rounded-lg transition-all" data-tipo="pix-qr">
                    Pix QR Code
                </button>
                <button class="pagamento-btn p-3 bg-gray-900 hover:bg-gray-800 border border-gray-700 rounded-lg transition-all" data-tipo="pix-cnpj">
                    Pix CNPJ
                </button>
                <button class="pagamento-btn p-3 bg-gray-900 hover:bg-gray-800 border border-gray-700 rounded-lg transition-all" data-tipo="prazo">
                    A Prazo
                </button>
                <button class="pagamento-btn p-3 bg-gray-900 hover:bg-gray-800 border border-gray-700 rounded-lg transition-all" data-tipo="dinheiro">
                    Dinheiro
                </button>
            </div>
            
            <div id="campoTroco" class="mt-4 hidden">
                <label class="block text-sm font-medium mb-2">Precisa de troco? Para quanto?</label>
                <input type="number" id="valorTroco" placeholder="Valor para troco" min="0" step="0.01"
                       class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg focus:ring-2 focus:ring-teal-500">
            </div>
            
            <div class="mt-4">
                <span class="text-sm text-gray-400">Selecionado: </span>
                <span id="pagamentoSelecionado" class="font-medium">Nenhum</span>
            </div>
        </div>

        <!-- Ações -->
        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 mt-6 bounce-in">
            <button id="copiarWhatsApp" class="flex-1 min-w-48 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:hover:scale-100 flex items-center justify-center gap-2" disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                </svg>
                Copiar para WhatsApp
            </button>
            <button id="imprimirPedido" class="flex-1 min-w-48 py-3 bg-teal-600 hover:bg-teal-700 rounded-lg font-medium transition-all duration-200 hover:scale-105 disabled:opacity-50 disabled:hover:scale-100 flex items-center justify-center gap-2" disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                </svg>
                Imprimir Pedido
            </button>
            <button id="novoPedido" class="py-3 px-6 bg-green-600 hover:bg-green-700 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Novo Pedido
            </button>
            <button id="exportarCSV" class="py-3 px-6 bg-teal-600 hover:bg-teal-700 rounded-lg font-medium transition-all duration-200 hover:scale-105 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Exportar CSV
            </button>
        </div>

        <!-- Status -->
        <div id="status" class="mt-4 p-3 rounded-lg hidden">
            <span id="statusMessage"></span>
        </div>
    </div>

    <!-- Área de Impressão (Oculta) -->
    <div id="printArea" class="hidden">
        <div style="font-family: 'Courier New', monospace; width: 80mm; font-size: 16px; line-height: 1.2; color: black;">
            <div style="text-align: center; margin-bottom: 8px;">
                <strong style="font-size: 18px;">SUPER NEGRELLI</strong><br>
                <span id="printPedidoCodigo" style="font-weight: bold;"></span><br>
                <span id="printData" style="font-size: 14px;"></span>
            </div>
            <div style="border-top: 2px dashed black; margin: 5px 0;"></div>
            <div id="printCliente" style="margin: 5px 0; font-size: 15px;"></div>
            <div style="border-top: 1px dashed black; margin: 5px 0;"></div>
            <div id="printItens" style="margin: 5px 0; font-size: 15px;"></div>
            <div style="border-top: 1px dashed black; margin: 5px 0;"></div>
            <div id="printPagamento" style="margin: 5px 0; font-size: 15px;"></div>
            <div style="text-align: center; margin-top: 8px;">
                <strong id="printTotal" style="font-size: 16px;"></strong>
            </div>
            <div style="text-align: center; margin-top: 10px; font-size: 12px;">
                Obrigado pela preferência!
            </div>
        </div>
    </div>

    <script>
        // Configuração do IndexedDB
        let db;
        const DB_NAME = 'SupermercadoDB';
        const DB_VERSION = 1;

        // Estado da aplicação
        let itensCompra = [];
        let formaPagamentoSelecionada = '';

        // Elementos DOM
        const elements = {
            telefone: document.getElementById('telefone'),
            nome: document.getElementById('nome'),
            cep: document.getElementById('cep'),
            rua: document.getElementById('rua'),
            numero: document.getElementById('numero'),
            complemento: document.getElementById('complemento'),
            bairro: document.getElementById('bairro'),
            cidade: document.getElementById('cidade'),
            // Função helper para pegar valores dos campos responsivos
            get quantidade() { 
                return document.getElementById('quantidade') || document.getElementById('quantidade-desktop');
            },
            get unidade() { 
                return document.getElementById('unidade') || document.getElementById('unidade-desktop');
            },
            get descricao() { 
                return document.getElementById('descricao') || document.getElementById('descricao-desktop');
            },
            listaItens: document.getElementById('listaItens'),
            pagamentoSelecionado: document.getElementById('pagamentoSelecionado'),
            campoTroco: document.getElementById('campoTroco'),
            valorTroco: document.getElementById('valorTroco'),
            status: document.getElementById('status'),
            statusMessage: document.getElementById('statusMessage')
        };

        // Helper para pegar elementos responsivos ativos
        function getActiveElements() {
            return {
                quantidade: document.getElementById('quantidade')?.offsetParent !== null ? 
                    document.getElementById('quantidade') : document.getElementById('quantidade-desktop'),
                unidade: document.getElementById('unidade')?.offsetParent !== null ? 
                    document.getElementById('unidade') : document.getElementById('unidade-desktop'),
                descricao: document.getElementById('descricao')?.offsetParent !== null ? 
                    document.getElementById('descricao') : document.getElementById('descricao-desktop')
            };
        }

        // Inicializar banco de dados
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // Store para clientes
                    if (!database.objectStoreNames.contains('clientes')) {
                        const clientesStore = database.createObjectStore('clientes', { keyPath: 'telefone' });
                        clientesStore.createIndex('nome', 'nome', { unique: false });
                    }
                    
                    // Store para pedidos
                    if (!database.objectStoreNames.contains('pedidos')) {
                        const pedidosStore = database.createObjectStore('pedidos', { keyPath: 'codigo' });
                        pedidosStore.createIndex('data', 'data', { unique: false });
                    }
                };
            });
        }

        // Utilitários
        function formatarTelefone(valor) {
            const numero = valor.replace(/\D/g, '');
            return numero.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }

        function formatarCEP(valor) {
            const cep = valor.replace(/\D/g, '');
            return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
        }

        function formatarMoeda(valor) {
            return parseFloat(valor || 0).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        function mostrarStatus(mensagem, tipo = 'info') {
            // Remover toasts anteriores
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());

            // Criar novo toast
            const toast = document.createElement('div');
            const bgColor = tipo === 'error' ? 'bg-red-500' : tipo === 'success' ? 'bg-green-500' : 'bg-blue-500';
            const icon = tipo === 'error' ? 
                `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>` :
                tipo === 'success' ?
                `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>` :
                `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`;

            toast.className = `toast-notification fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 z-50 slide-in`;
            toast.innerHTML = `
                ${icon}
                <span>${mensagem}</span>
                <button onclick="this.parentElement.remove()" class="ml-2 hover:bg-white hover:bg-opacity-20 rounded p-1 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;
            
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function toggleLoading(button, isLoading) {
            const loadingIcon = button.querySelector('.loading-icon');
            const searchIcon = button.querySelector('.search-icon');
            
            if (isLoading) {
                if (loadingIcon) {
                    loadingIcon.classList.remove('hidden');
                    loadingIcon.classList.add('loading-spinner');
                }
                if (searchIcon) searchIcon.classList.add('hidden');
                button.disabled = true;
            } else {
                if (loadingIcon) {
                    loadingIcon.classList.add('hidden');
                    loadingIcon.classList.remove('loading-spinner');
                }
                if (searchIcon) searchIcon.classList.remove('hidden');
                button.disabled = false;
            }
        }

        // Gerar código único do pedido
        function gerarCodigoPedido() {
            const hoje = new Date();
            const data = hoje.toISOString().split('T')[0].replace(/-/g, '');
            const numero = String(Date.now()).slice(-4);
            return `PED${data}${numero}`;
        }

        // Salvar cliente no banco
        function salvarCliente(cliente) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['clientes'], 'readwrite');
                const store = transaction.objectStore('clientes');
                const request = store.put(cliente);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Buscar cliente no banco
        function buscarCliente(telefone) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['clientes'], 'readonly');
                const store = transaction.objectStore('clientes');
                const request = store.get(telefone);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Salvar pedido no banco
        function salvarPedido(pedido) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pedidos'], 'readwrite');
                const store = transaction.objectStore('pedidos');
                const request = store.put(pedido);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Buscar CEP via ViaCEP
        async function buscarCEP(cep) {
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep.replace(/\D/g, '')}/json/`);
                const data = await response.json();
                
                if (data.erro) {
                    throw new Error('CEP não encontrado');
                }
                
                return data;
            } catch (error) {
                throw error;
            }
        }

        // Buscar pedidos por data
        function buscarPedidosPorData(data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['pedidos'], 'readonly');
                const store = transaction.objectStore('pedidos');
                const index = store.index('data');
                
                const pedidos = [];
                const request = index.openCursor();
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const pedidoData = cursor.value.data.split('T')[0];
                        if (pedidoData === data) {
                            pedidos.push(cursor.value);
                        }
                        cursor.continue();
                    } else {
                        resolve(pedidos);
                    }
                };
                
                request.onerror = () => reject(request.error);
            });
        }

        function atualizarListaItens() {
            elements.listaItens.innerHTML = '';

            itensCompra.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-900 rounded-lg item-enter hover:bg-gray-800 transition-colors';
                div.innerHTML = `
                    <div class="flex-1">
                        <span class="font-medium">${item.quantidade} ${item.unidade} - ${item.descricao}</span>
                    </div>
                    <button onclick="removerItem(${index})" class="ml-3 px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-sm transition-all duration-200 hover:scale-110 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                `;
                elements.listaItens.appendChild(div);
            });

            // Adicionar mensagem se não houver itens
            if (itensCompra.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'text-center text-gray-400 py-8 fade-in';
                emptyDiv.innerHTML = `
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5L2 21m5-8v8a2 2 0 002 2h6a2 2 0 002-2v-8"/>
                    </svg>
                    <p>Nenhum item adicionado ainda</p>
                    <p class="text-sm mt-1">Use o formulário acima para adicionar produtos</p>
                `;
                elements.listaItens.appendChild(emptyDiv);
            }
        }

        function removerItem(index) {
            itensCompra.splice(index, 1);
            atualizarListaItens();
            verificarValidadePedido();
        }

        function limparCamposItem() {
            const activeElements = getActiveElements();
            activeElements.quantidade.value = '';
            activeElements.descricao.value = '';
            activeElements.quantidade.focus();
        }

        function verificarValidadePedido() {
            const telefoneValido = elements.telefone.value.replace(/\D/g, '').length >= 10;
            const nomeValido = elements.nome.value.trim() !== '';
            const enderecoValido = elements.rua.value.trim() !== '' && elements.cidade.value.trim() !== '';
            const temItens = itensCompra.length > 0;
            const temPagamento = formaPagamentoSelecionada !== '';

            const pedidoValido = telefoneValido && nomeValido && enderecoValido && temItens && temPagamento;

            document.getElementById('copiarWhatsApp').disabled = !pedidoValido;
            document.getElementById('imprimirPedido').disabled = !pedidoValido;
        }

        // Event Listeners
        elements.telefone.addEventListener('input', (e) => {
            e.target.value = formatarTelefone(e.target.value);
        });

        elements.cep.addEventListener('input', (e) => {
            e.target.value = formatarCEP(e.target.value);
        });

        elements.cep.addEventListener('blur', async (e) => {
            const cep = e.target.value.replace(/\D/g, '');
            if (cep.length === 8) {
                // Adicionar indicador visual de loading no campo CEP
                e.target.classList.add('animate-pulse');
                try {
                    const endereco = await buscarCEP(cep);
                    elements.rua.value = endereco.logradouro || '';
                    elements.bairro.value = endereco.bairro || '';
                    elements.cidade.value = endereco.localidade || '';
                    mostrarStatus('CEP encontrado!', 'success');
                } catch (error) {
                    mostrarStatus('CEP não encontrado', 'error');
                } finally {
                    e.target.classList.remove('animate-pulse');
                }
            }
        });

        document.getElementById('buscarCliente').addEventListener('click', async () => {
            const telefone = elements.telefone.value.replace(/\D/g, '');
            const button = document.getElementById('buscarCliente');
            
            if (telefone.length >= 10) {
                toggleLoading(button, true);
                try {
                    const cliente = await buscarCliente(elements.telefone.value);
                    if (cliente) {
                        elements.nome.value = cliente.nome || '';
                        elements.cep.value = cliente.cep || '';
                        elements.rua.value = cliente.rua || '';
                        elements.numero.value = cliente.numero || '';
                        elements.complemento.value = cliente.complemento || '';
                        elements.bairro.value = cliente.bairro || '';
                        elements.cidade.value = cliente.cidade || '';
                        mostrarStatus('Cliente encontrado!', 'success');
                    } else {
                        mostrarStatus('Cliente não encontrado', 'info');
                    }
                } catch (error) {
                    mostrarStatus('Erro ao buscar cliente', 'error');
                } finally {
                    toggleLoading(button, false);
                }
            } else {
                mostrarStatus('Digite um telefone válido', 'error');
            }
        });

        document.getElementById('adicionarItem').addEventListener('click', () => {
            const activeElements = getActiveElements();
            const quantidade = parseFloat(activeElements.quantidade.value);
            const unidade = activeElements.unidade.value;
            const descricao = activeElements.descricao.value.trim();

            if (!quantidade || !descricao) {
                mostrarStatus('Preencha quantidade e descrição', 'error');
                return;
            }

            const item = {
                id: Date.now(),
                quantidade,
                unidade,
                descricao
            };

            itensCompra.push(item);
            atualizarListaItens();
            limparCamposItem();
            verificarValidadePedido();
        });

        // Forma de pagamento
        document.querySelectorAll('.pagamento-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.pagamento-btn').forEach(b => {
                    b.classList.remove('bg-teal-600', 'border-teal-500');
                    b.classList.add('bg-gray-900', 'border-gray-700');
                });
                
                btn.classList.remove('bg-gray-900', 'border-gray-700');
                btn.classList.add('bg-teal-600', 'border-teal-500');
                
                formaPagamentoSelecionada = btn.dataset.tipo;
                elements.pagamentoSelecionado.textContent = btn.textContent;
                
                if (formaPagamentoSelecionada === 'dinheiro') {
                    elements.campoTroco.classList.remove('hidden');
                } else {
                    elements.campoTroco.classList.add('hidden');
                    elements.valorTroco.value = '';
                }
                
                verificarValidadePedido();
            });
        });

        // Copiar para WhatsApp
        document.getElementById('copiarWhatsApp').addEventListener('click', () => {
            const cliente = {
                telefone: elements.telefone.value,
                nome: elements.nome.value,
                endereco: `${elements.rua.value}, ${elements.numero.value}${elements.complemento.value ? ', ' + elements.complemento.value : ''}, ${elements.bairro.value}, ${elements.cidade.value}`
            };

            let texto = `🛒 *PEDIDO - ${gerarCodigoPedido()}*\n\n`;
            texto += `👤 *Cliente:* ${cliente.nome}\n`;
            texto += `📞 *Telefone:* ${cliente.telefone}\n`;
            texto += `📍 *Endereço:* ${cliente.endereco}\n\n`;
            texto += `🛍️ *Itens:*\n`;
            
            itensCompra.forEach(item => {
                texto += `• ${item.quantidade} ${item.unidade} - ${item.descricao}\n`;
            });
            
            texto += `💳 *Pagamento:* ${document.querySelector('.pagamento-btn.bg-teal-600').textContent}`;
            
            if (formaPagamentoSelecionada === 'dinheiro' && elements.valorTroco.value) {
                texto += ` - Troco para ${formatarMoeda(elements.valorTroco.value)}`;
            }

            navigator.clipboard.writeText(texto).then(() => {
                mostrarStatus('Pedido copiado para área de transferência!', 'success');
            });
        });

        // Imprimir pedido
        document.getElementById('imprimirPedido').addEventListener('click', async () => {
            const codigo = gerarCodigoPedido();
            const agora = new Date();
            
            // Salvar cliente
            const cliente = {
                telefone: elements.telefone.value,
                nome: elements.nome.value,
                cep: elements.cep.value,
                rua: elements.rua.value,
                numero: elements.numero.value,
                complemento: elements.complemento.value,
                bairro: elements.bairro.value,
                cidade: elements.cidade.value
            };
            
            try {
                await salvarCliente(cliente);
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
            }

            // Preparar dados para impressão
            document.getElementById('printPedidoCodigo').textContent = codigo;
            document.getElementById('printData').textContent = agora.toLocaleString('pt-BR');
            
            document.getElementById('printCliente').innerHTML = `
                <strong>CLIENTE:</strong><br>
                ${cliente.nome}<br>
                ${cliente.telefone}<br>
                ${elements.rua.value}, ${elements.numero.value}<br>
                ${elements.complemento.value ? elements.complemento.value + '<br>' : ''}
                ${elements.bairro.value}, ${elements.cidade.value}
            `;
            
            let itensHTML = '<strong>ITENS:</strong><br>';
            itensCompra.forEach(item => {
                itensHTML += `${item.quantidade} ${item.unidade} - ${item.descricao}<br>`;
            });
            document.getElementById('printItens').innerHTML = itensHTML;
            
            let pagamentoText = document.querySelector('.pagamento-btn.bg-teal-600').textContent;
            if (formaPagamentoSelecionada === 'dinheiro' && elements.valorTroco.value) {
                pagamentoText += ` - Troco: ${formatarMoeda(elements.valorTroco.value)}`;
            }
            document.getElementById('printPagamento').innerHTML = `<strong>PAGAMENTO:</strong><br>${pagamentoText}`;
            
            // Removido total pois valores foram removidos
            document.getElementById('printTotal').textContent = '';

            // Salvar pedido
            const pedido = {
                codigo,
                data: agora.toISOString(),
                cliente,
                itens: [...itensCompra],
                formaPagamento: formaPagamentoSelecionada,
                valorTroco: elements.valorTroco.value || null
            };

            try {
                await salvarPedido(pedido);
                mostrarStatus('Pedido salvo com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
            }

            // Imprimir
            window.print();
        });

        // Novo pedido
        document.getElementById('novoPedido').addEventListener('click', () => {
            if (confirm('Deseja iniciar um novo pedido? Os dados atuais serão perdidos.')) {
                // Limpar formulário
                Object.values(elements).forEach(el => {
                    if (el && el.value !== undefined) el.value = '';
                });
                
                // Resetar estado
                itensCompra = [];
                formaPagamentoSelecionada = '';
                
                // Resetar interface
                atualizarListaItens();
                elements.pagamentoSelecionado.textContent = 'Nenhum';
                elements.campoTroco.classList.add('hidden');
                
                // Resetar botões de pagamento
                document.querySelectorAll('.pagamento-btn').forEach(btn => {
                    btn.classList.remove('bg-teal-600', 'border-teal-500');
                    btn.classList.add('bg-gray-900', 'border-gray-700');
                });
                
                verificarValidadePedido();
                elements.telefone.focus();
                mostrarStatus('Novo pedido iniciado!', 'success');
            }
        });

        // Exportar CSV
        document.getElementById('exportarCSV').addEventListener('click', async () => {
            const hoje = new Date().toISOString().split('T')[0];
            
            try {
                const pedidosHoje = await buscarPedidosPorData(hoje);
                
                if (pedidosHoje.length === 0) {
                    mostrarStatus('Nenhum pedido encontrado para hoje', 'info');
                    return;
                }

                let csvContent = 'Codigo,Data,Cliente,Telefone,Endereco,Itens,Pagamento\n';
                
                pedidosHoje.forEach(pedido => {
                    const endereco = `${pedido.cliente.rua} ${pedido.cliente.numero} ${pedido.cliente.complemento} ${pedido.cliente.bairro} ${pedido.cliente.cidade}`.replace(/\s+/g, ' ').trim();
                    const itensDesc = pedido.itens.map(item => `${item.quantidade}${item.unidade} ${item.descricao}`).join('; ');
                    
                    csvContent += `"${pedido.codigo}","${new Date(pedido.data).toLocaleString('pt-BR')}","${pedido.cliente.nome}","${pedido.cliente.telefone}","${endereco}","${itensDesc}","${pedido.formaPagamento}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `pedidos_${hoje}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                mostrarStatus(`${pedidosHoje.length} pedidos exportados!`, 'success');
            } catch (error) {
                mostrarStatus('Erro ao exportar CSV', 'error');
                console.error('Erro:', error);
            }
        });

        // Adicionar listeners para validação em tempo real
        ['telefone', 'nome', 'rua', 'cidade'].forEach(campo => {
            elements[campo].addEventListener('input', verificarValidadePedido);
        });

        // Permitir Enter para adicionar itens - versão responsiva
        function addEnterListeners() {
            const campos = [
                document.getElementById('quantidade'),
                document.getElementById('quantidade-desktop'),
                document.getElementById('descricao'),
                document.getElementById('descricao-desktop')
            ].filter(Boolean);
            
            campos.forEach(input => {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.getElementById('adicionarItem').click();
                    }
                });
            });
        }
        
        addEnterListeners();

        // Removido auto-foco da quantidade para permitir digitação de múltiplos dígitos

        // Removido auto-foco do campo descrição pois campo valor foi removido

        // Permitir apenas números nos campos numéricos
        [elements.numero].forEach(input => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '');
            });
        });

        // Inicializar aplicação
        async function iniciarApp() {
            try {
                await initDB();
                elements.telefone.focus();
                mostrarStatus('Sistema iniciado com sucesso!', 'success');
            } catch (error) {
                mostrarStatus('Erro ao inicializar sistema', 'error');
                console.error('Erro:', error);
            }
        }

        // Função global para remover itens (chamada pelo onclick)
        window.removerItem = removerItem;

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', iniciarApp);
    </script>
</body>
</html>